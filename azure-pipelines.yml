trigger:
- master

pool:
  vmImage: 'windows-latest' # Kept as Windows per your request

variables:
  buildConfiguration: 'Release'
  webProject: 'EnvioMasivoEmail_MVC/EnvioMasivoEmail_MVC.csproj'
  syncToolProject: 'AzureTestSyncApp/AzureTestSyncApp.csproj'
  # Define a path for NuGet packages to enable caching
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages

steps:
# 1. Cache NuGet Packages (Crucial for Windows speed)
- task: Cache@2
  displayName: 'Cache NuGet packages'
  inputs:
    key: 'nuget | "$(Agent.OS)" | **/packages.lock.json,!**/bin/**,!**/obj/**'
    restoreKeys: |
       nuget | "$(Agent.OS)"
    path: $(NUGET_PACKAGES)

# 2. Restore dependencies for ALL projects
- task: DotNetCoreCLI@2
  displayName: 'Restore All Dependencies'
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

# 3. Build the Console App (Sync Tool)
- task: DotNetCoreCLI@2
  displayName: 'Build Sync Tool'
  inputs:
    command: 'build'
    projects: '$(syncToolProject)'
    # Added --no-restore so it uses the packages from Step 2
    arguments: '--configuration $(buildConfiguration) --no-restore'

# 4. EXECUTE the Console App
- task: DotNetCoreCLI@2
  displayName: 'Run AzureTestSyncApp'
  inputs:
    command: 'run'
    projects: '$(syncToolProject)'
    # OPTIMIZATION: --no-build tells dotnet to assume the binary is ready. 
    # This skips the "check for changes" phase.
    arguments: '--configuration $(buildConfiguration) --no-build'
    workingDirectory: 'AzureTestSyncApp'
  env:
    PERSONAL_ACCESS_TOKEN: $(MyAzurePAT) 
    ORGANIZATION_URL: 'https://dev.azure.com/UTN-FabricaSoftware-2025'
    PROJECT_NAME: 'CorreosMasivos'
    PLAN_ID: '38'

# REMOVED: "Build Web App" step. 
# Reason: The "Publish" command below compiles the code anyway.

# 5. Publish the Web App (Compiles & Zips)
- task: DotNetCoreCLI@2
  displayName: 'Publish Web App'
  inputs:
    command: 'publish'
    projects: '$(webProject)'
    publishWebProjects: false 
    # OPTIMIZATION: --no-restore skips the restore check (we did it in step 2)
    arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) --no-restore'
    zipAfterPublish: true

# 6. Deploy to Azure
- task: AzureWebApp@1
  displayName: 'Azure Web App Deploy'
  inputs:
    azureSubscription: 'AzureConnection' 
    appType: 'webApp'
    appName: 'correos-masivos' 
    package: '$(Build.ArtifactStagingDirectory)/**/*.zip'