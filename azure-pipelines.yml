trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  webProject: 'EnvioMasivoEmail_MVC/EnvioMasivoEmail_MVC.csproj'
  syncToolProject: 'AzureTestSyncApp/AzureTestSyncApp.csproj'
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: 1
  # Default the variable to false
  RunSyncSteps: 'false'

steps:
# 0. IMPORTANT: Ensure git history is available for diff
- checkout: self
  fetchDepth: 0

# 1. NEW STEP: Check if .feature files OR Sync Tool code changed
- powershell: |
    # Get the list of changed files between the last commit and current
    $changes = git diff --name-only HEAD~1 HEAD
    Write-Host "Changed files:"
    Write-Host $changes
    
    # Check if any file ends with .feature OR contains 'AzureTestSyncApp' in the path
    if ($changes -match "\.feature$" -or $changes -match "AzureTestSyncApp") {
      Write-Host "##vso[task.setvariable variable=RunSyncSteps]true"
      Write-Host "Detected changes in Feature files or Sync Tool code. Sync Tool will run."
    } else {
      Write-Host "No relevant changes detected. Sync Tool steps will be skipped."
    }
  displayName: 'Check for changes (.feature or SyncTool)'

# 2. Cache NuGet Packages (Always run)
- task: Cache@2
  displayName: 'Cache NuGet packages'
  inputs:
    key: 'nuget | "$(Agent.OS)" | **/*.csproj,!**/bin/**,!**/obj/**'
    restoreKeys: |
       nuget | "$(Agent.OS)"
    path: $(NUGET_PACKAGES)

# 3. Restore dependencies (Always run)
- task: DotNetCoreCLI@2
  displayName: 'Restore All Dependencies'
  inputs:
    command: 'restore'
    projects: '**/*.csproj'
    feedsToUse: 'config'           # Le decimos que use un archivo config
    nugetConfigPath: 'nuget.config' # La ruta al archivo que creaste

# 4. Build the Console App (CONDITIONAL)
- task: DotNetCoreCLI@2
  displayName: 'Build Sync Tool'
  # Only run if RunSyncSteps is true
  condition: and(succeeded(), eq(variables['RunSyncSteps'], 'true'))
  inputs:
    command: 'build'
    projects: '$(syncToolProject)'
    arguments: '--configuration $(buildConfiguration) --no-restore --output $(Build.BinariesDirectory)/SyncTool'

# 5. EXECUTE the Console App (CONDITIONAL)
- script: |
    dotnet "$(Build.BinariesDirectory)/SyncTool/AzureTestSyncApp.dll"
  displayName: 'Run AzureTestSyncApp Direct'
  # Only run if RunSyncSteps is true
  condition: and(succeeded(), eq(variables['RunSyncSteps'], 'true'))
  workingDirectory: 'AzureTestSyncApp'
  env:
    PERSONAL_ACCESS_TOKEN: $(MyAzurePAT) 
    ORGANIZATION_URL: 'https://dev.azure.com/UTN-FabricaSoftware-2025'
    PROJECT_NAME: 'CorreosMasivos'
    PLAN_ID: '63'

# 6. Publish the Web App (Always runs)
- task: DotNetCoreCLI@2
  displayName: 'Publish Web App'
  inputs:
    command: 'publish'
    projects: '$(webProject)'
    publishWebProjects: false 
    arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) --no-restore'
    zipAfterPublish: true

# 6.5. A: CREAR EL PAQUETE NUGET (PACK)
- task: DotNetCoreCLI@2
  displayName: 'Pack NuGet Package'
  inputs:
    command: 'pack'
    # Asegúrate de apuntar al proyecto que tiene el <IsPackable>true
    projects: 'EnvioMasivoEmail_MVC/EnvioMasivoEmail_MVC.csproj'
    # Esto genera versiones automáticas tipo 1.0.543, 1.0.544
    versioningScheme: 'byPrereleaseNumber' 
    majorVersion: '1'
    minorVersion: '0'
    patchVersion: '$(Build.BuildId)'
    # Guardamos el paquete en una carpeta temporal para subirlo luego
    outputDir: '$(Build.ArtifactStagingDirectory)/nuget'

# 6.5. B: SUBIR AL FEED (PUSH)
- task: NuGetCommand@2
  displayName: 'Push NuGet to Feed'
  inputs:
    command: 'push'
    # Busca los archivos .nupkg en la carpeta donde los creamos arriba
    packagesToPush: '$(Build.ArtifactStagingDirectory)/nuget/*.nupkg;!$(Build.ArtifactStagingDirectory)/nuget/*.symbols.nupkg'
    nuGetFeedType: 'internal'
    # Aquí va el nombre de tu feed tal como sale en la URL de tu imagen
    publishVstsFeed: 'UTN-FabricaSoftware-2025'
    allowPackageConflicts: true

# NUEVO PASO: Subir el artifact para que aparezca el "1" en la interfaz
- task: PublishBuildArtifacts@1
  displayName: 'Upload Artifacts'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop' # Nombre de la carpeta que verás al descargar
    publishLocation: 'Container'

# 7. Deploy to Azure 
- task: AzureWebApp@1
  displayName: 'Azure Web App Deploy'
  inputs:
    azureSubscription: 'AzureConnection' 
    appType: 'webApp'
    appName: 'correos-masivos' 
    package: '$(Build.ArtifactStagingDirectory)/**/*.zip'